
<!DOCTYPE html>

<html>

    <head>
        <title>Visualizer</title>
    </head>


    <body>
        <input type="file" id="trace-file-picker" @change="loadSelectedFile">
        <br><br>
        <div id="trace-display"></div>
        <br><br>
    </body>

    <script lang="javascript">

        // TODO expand/collapse

        var trace = [];

        debugger;   // TODO remove

        class LineVisitedEvent {
            constructor(event){
                this.uid = event.uid;
                this.newLine = `${event.newLine.filename}:${event.newLine.lineIdx}`;
                this.visibleVars = event.visibleVars;
                this.stackParentUid = event.stackParentUid;
            };
            toString() {
                return `VISIT ${this.newLine}`   // FIXME also display vars
            };
        };

        class FunCallEvent {
            constructor(event){
                this.uid = event.uid;
                this.funId = event.funId;
                this.args = event.args;
                this.stackParentUid = event.stackParentUid;
            };
            toString(){
                let argsDescr = (
                    this.args == null ?
                        "<?? missing arguments>"
                    :   this.args.map(e => `${e.first} = ${e.second}`).join(', ')
                );
                return `CALL ${this.funId}(${argsDescr})`;
            };
        };

        class FunExitEvent {
            constructor(event){
                this.uid = event.uid;
                this.funId = event.funId;
                this.retVal = event.retVal;
                this.stackParentUid = event.stackParentUid;
            };
            toString(){
                return `RETURN ${this.retVal} from ${this.funId}`;
            };
        };

        document.getElementById("trace-file-picker").addEventListener("change", function(event){
            let file = event.target.files[0];
            if (!file){
                return;
            };
            let reader = new FileReader();
            reader.onload = function(event){
                let fileContents = event.target.result;
                let json = JSON.parse(fileContents);
                populateTrace(json);
                displayTrace();
            };
            reader.readAsText(file);
            document.title = "Visualizer: " + file.name.slice(0, -5);
        });

        function populateTrace(json){
            trace = [];
            for (evIdx in json){
                let jEvent = json[evIdx];
                switch(jEvent.type){
                    case "LineVisitedEvent":
                        trace.push(new LineVisitedEvent(jEvent));
                        break;
                    case "FunCallEvent":
                        trace.push(new FunCallEvent(jEvent));
                        break;
                    case "FunExitEvent":
                        trace.push(new FunExitEvent(jEvent));
                        break;
                };
            };
        };

        function displayTrace(){
            let traceDisplay = document.getElementById("trace-display");
            // clear children
            while (traceDisplay.lastElementChild){
                traceDisplay.removeChild(traceDisplay.lastElementChild);
            };
            // add new children
            traceDisplay.appendChild(traceElementsLayered(0).layerNode);
        };

        function traceElementsLayered(startIdx, indent){
            let layerNode = document.createElement("div");
            layerNode.style.paddingLeft = "15px";
            let idx = startIdx;
            let reachedExit = false;
            while (idx < trace.length && !reachedExit){
                let event = trace[idx];
                let eventNode = document.createElement("p");
                eventNode.id = eventNodeId(event.uid);
                eventNode.textContent = event.toString();
                if (event instanceof FunCallEvent){
                    let details = document.createElement("details");
                    let summary = document.createElement("summary");
                    summary.style.display = "block";
                    summary.appendChild(eventNode);
                    details.appendChild(summary);
                    let recRes = traceElementsLayered(idx + 1);
                    details.appendChild(recRes.layerNode);
                    layerNode.appendChild(details);
                    idx = recRes.idx;
                } else if (event instanceof LineVisitedEvent) {
                    layerNode.appendChild(eventNode);
                    idx += 1;
                } else if (event instanceof FunExitEvent){
                    layerNode.appendChild(eventNode);
                    reachedExit = true;
                    idx += 1;
                } else {
                    throw "unexpected " + (typeof event);
                };
            };
            return {layerNode, idx};
        };

        function eventNodeId(eventUid){
            return `event-${eventUid}`;
        };

    </script>


</html>

