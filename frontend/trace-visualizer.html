
<!DOCTYPE html>

<html>

    <head>
        <title>Visualizer</title>
    </head>


    <body>
        <div style="font-family: Consolas;">
            <input type="file" id="trace-file-picker" @change="loadSelectedFile">
            <br><br>
            <div id="trace-display"></div>
            <br><br>
        </div>
    </body>

    <script lang="javascript">

        const HIGHLIGHT_COLOR = "#F4E98F";

        var traceDict = {};
        var highlighted = [];

        debugger;   // TODO remove

        class LineVisitedEvent {
            constructor(event){
                this.uid = event.uid;
                this.newLine = `${event.newLine.filename}:${event.newLine.lineIdx}`;
                this.visibleVars = event.visibleVars;
                this.stackParentUid = event.stackParentUid;
            };
            toString() {
                return `VISIT ${this.newLine}`   // FIXME also display vars
            };
        };

        class FunCallEvent {
            constructor(event){
                this.uid = event.uid;
                this.funId = event.funId;
                this.args = event.args;
                this.stackParentUid = event.stackParentUid;
            };
            toString(){
                let argsDescr = (
                    this.args == null ?
                        "<?? missing arguments>"
                    :   this.args.map(e => `${e.first} = ${e.second == null ? "<??>" : e.second}`).join(', ')
                );
                return `CALL ${this.funId}(${argsDescr})`;
            };
        };

        class FunExitEvent {
            constructor(event){
                this.uid = event.uid;
                this.funId = event.funId;
                this.retVal = event.retVal;
                this.stackParentUid = event.stackParentUid;
            };
            toString(){
                return `RETURN ${this.retVal} from ${this.funId}`;
            };
        };

        document.getElementById("trace-file-picker").addEventListener("change", function(event){
            let file = event.target.files[0];
            if (!file){
                return;
            };
            let reader = new FileReader();
            reader.onload = function(event){
                let fileContents = event.target.result;
                let json = JSON.parse(fileContents);
                let trace = readJson(json);
                displayTrace(trace);
            };
            reader.readAsText(file);
            document.title = "Visualizer: " + file.name.slice(0, -5);
        });

        function readJson(json){
            traceDict = {};
            let trace = [];
            for (evIdx in json){
                let jEvent = json[evIdx];
                let event = null;
                switch(jEvent.type){
                    case "LineVisitedEvent":
                        event = new LineVisitedEvent(jEvent);
                        break;
                    case "FunCallEvent":
                        event = new FunCallEvent(jEvent);
                        break;
                    case "FunExitEvent":
                        event = new FunExitEvent(jEvent);
                        break;
                };
                trace.push(event);
                traceDict[event.uid] = event;
            };
            return trace;
        };

        function displayTrace(trace){
            let traceDisplay = document.getElementById("trace-display");
            // clear children
            while (traceDisplay.lastElementChild){
                traceDisplay.removeChild(traceDisplay.lastElementChild);
            };
            // add new children
            traceDisplay.appendChild(traceElementsLayered(trace, 0).layerNode);
        };

        function traceElementsLayered(trace, startIdx){
            let layerNode = document.createElement("div");
            layerNode.style.paddingLeft = "25px";
            let idx = startIdx;
            let reachedExit = false;
            while (idx < trace.length && !reachedExit){
                let event = trace[idx];
                if (event instanceof FunCallEvent){
                    let details = document.createElement("details");
                    let summary = document.createElement("summary");
                    summary.id = eventNodeId(event.uid);
                    summary.textContent = event.toString();
                    summary.style.border = "1px solid white";
                    summary.addEventListener("mouseenter", function(){
                        highlight(event.uid);
                        details.style.border = "1px solid lightblue";
                    });
                    summary.addEventListener("mouseleave", function(){
                        removeHighlighting();
                        details.style.border = "1px solid white";
                    });
                    details.appendChild(summary);
                    let recRes = traceElementsLayered(trace, idx + 1);
                    details.appendChild(recRes.layerNode);
                    layerNode.appendChild(details);
                    idx = recRes.idx;
                } else if (event instanceof LineVisitedEvent || event instanceof FunExitEvent) {
                    let eventNode = document.createElement("div");
                    eventNode.id = eventNodeId(event.uid);
                    eventNode.textContent = event.toString();
                    eventNode.addEventListener("mouseenter", function(){ highlight(event.uid); });
                    eventNode.addEventListener("mouseleave", function(){ removeHighlighting(); });
                    layerNode.appendChild(eventNode);
                    reachedExit = (event instanceof FunExitEvent);
                    idx += 1;
                } else {
                    throw "unexpected " + event.toString();
                };
            };
            return { layerNode, idx };
        };

        function highlight(leafEventUid){
            let eventUid = leafEventUid;
            while (eventUid){
                let id = eventNodeId(eventUid);
                let eventNode = document.getElementById(id);
                eventNode.style.backgroundColor = HIGHLIGHT_COLOR;
                highlighted.push(eventNode);
                eventUid = traceDict[eventUid].stackParentUid;
            };
        };

        function removeHighlighting(){
            while (highlighted.length > 0){
                let child = highlighted.pop();
                child.style.backgroundColor = "";
            };
        };

        function eventNodeId(eventUid){
            return `event-${eventUid}`;
        };

    </script>


</html>

